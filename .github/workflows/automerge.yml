name: Daily merge from upstream into main

on:
  schedule:
    - cron: '0 8 * * *'  # daily at 08:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest

    steps:
      # Checkout your fork's main branch
      - name: Checkout your fork main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # Git config
      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ---- BRANCH MERGE ----
      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/morettt/my-neuro.git
          git fetch upstream --tags --prune

      - name: Merge upstream/main into main
        run: |
          git merge upstream/main --allow-unrelated-histories --no-edit || echo "Merge conflict or no changes"

      - name: Push merged main
        run: |
          git push origin main

      # ---- TAG SYNC ----
      - name: Sync tags from upstream to fork
        run: |
          git fetch upstream --tags
          git push origin --tags

      # ---- RELEASE & ASSET SYNC (robust API version) ----
      - name: Sync releases and assets
        env:
          TOKEN: ${{ secrets.UPSTREAM_SYNC_PAT }}
          REPO_FORK: ${{ github.repository }}
          REPO_UPSTREAM: "morettt/my-neuro"
        run: |
          echo "Fetching upstream releasesâ€¦"

          # fetch releases from upstream
          UPSTREAM=$(curl -s -H "Authorization: token $TOKEN" \
            https://api.github.com/repos/$REPO_UPSTREAM/releases)

          echo "$UPSTREAM" | jq -c '.[]' | while read rel; do
            TAG=$(echo "$rel" | jq -r '.tag_name')
            NAME=$(echo "$rel" | jq -r '.name')
            BODY=$(echo "$rel" | jq -r '.body' | jq -Rs .)
            DRAFT=$(echo "$rel" | jq -r '.draft')
            PRERELEASE=$(echo "$rel" | jq -r '.prerelease')

            echo "âž¡ï¸ Processing release $TAG"

            # check if release exists in fork
            EXISTING=$(curl -s -H "Authorization: token $TOKEN" \
              https://api.github.com/repos/$REPO_FORK/releases/tags/$TAG)

            if [[ "$(echo "$EXISTING" | jq -r '.id')" == "null" ]]; then
              echo "ðŸ†• Creating release $TAG in forkâ€¦"
              FORK_RELEASE=$(curl -s -X POST \
                -H "Authorization: token $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"tag_name\":\"$TAG\",\"name\":\"$NAME\",\"body\":$BODY,\"draft\":$DRAFT,\"prerelease\":$PRERELEASE}" \
                https://api.github.com/repos/$REPO_FORK/releases)
            else
              echo "âœ”ï¸ Updating release $TAG in forkâ€¦"
              RELEASE_ID=$(echo "$EXISTING" | jq -r '.id')
              FORK_RELEASE=$(curl -s -X PATCH \
                -H "Authorization: token $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"name\":\"$NAME\",\"body\":$BODY,\"draft\":$DRAFT,\"prerelease\":$PRERELEASE}" \
                https://api.github.com/repos/$REPO_FORK/releases/$RELEASE_ID)
            fi

            RELEASE_ID=$(echo "$FORK_RELEASE" | jq -r '.id')

            echo "â¬‡ï¸ Syncing assets for $TAGâ€¦"
            echo "$rel" | jq -c '.assets[]?' | while read asset; do
              ASSET_NAME=$(echo "$asset" | jq -r '.name')
              ASSET_URL=$(echo "$asset" | jq -r '.url')

              echo "   â†’ Downloading $ASSET_NAME"
              curl -L \
                -H "Authorization: token $TOKEN" \
                -H "Accept: application/octet-stream" \
                "$ASSET_URL" -o "$ASSET_NAME"

              echo "   â†’ Uploading $ASSET_NAME to fork release $TAG"
              curl -s -X POST \
                -H "Authorization: token $TOKEN" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$ASSET_NAME" \
                "https://uploads.github.com/repos/$REPO_FORK/releases/$RELEASE_ID/assets?name=$ASSET_NAME" \
                >/dev/null
            done
          done

          echo "ðŸŽ‰ Release & asset sync complete!"
